services:
  api:
    build:
      context: .
    image: assetguard-api:latest
    container_name: assetguard-api-prod
    restart: always
    ports:
      - "3000:3000"
    env_file:
      - .env
    environment:
      NODE_ENV: production
      PORT: ${PORT:-3000}
      SUPABASE_DATABASE_URL: ${SUPABASE_DATABASE_URL:?SUPABASE_DATABASE_URL is required}
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:?JWT_EXPIRES_IN is required}
      JWT_REFRESH_EXPIRES_IN: ${JWT_REFRESH_EXPIRES_IN:?JWT_REFRESH_EXPIRES_IN is required}
      SUPABASE_STORAGE_ENDPOINT: ${SUPABASE_STORAGE_ENDPOINT:?SUPABASE_STORAGE_ENDPOINT is required}
      SUPABASE_STORAGE_REGION: ${SUPABASE_STORAGE_REGION:?SUPABASE_STORAGE_REGION is required}
      SUPABASE_STORAGE_BUCKET: ${SUPABASE_STORAGE_BUCKET:?SUPABASE_STORAGE_BUCKET is required}
      SUPABASE_STORAGE_ACCESS_KEY_ID: ${SUPABASE_STORAGE_ACCESS_KEY_ID:?SUPABASE_STORAGE_ACCESS_KEY_ID is required}
      SUPABASE_STORAGE_SECRET_ACCESS_KEY: ${SUPABASE_STORAGE_SECRET_ACCESS_KEY:?SUPABASE_STORAGE_SECRET_ACCESS_KEY is required}
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://127.0.0.1:3000/docs',res=>process.exit(res.statusCode<500?0:1)).on('error',()=>process.exit(1))",
        ]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 30s
